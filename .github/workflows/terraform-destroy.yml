name: terraform-destroy

on:
  workflow_dispatch:
    inputs:
      var_file:
        description: "Chemin du .tfvars (relatif à infra/, ex: prod.tfvars)"
        required: false
        default: ""
      target:
        description: "Optionnel: -target=... (module/ressource). Laisser vide pour tout détruire."
        required: false
        default: ""

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-west-1
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

concurrency:
  group: tf-destroy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  destroy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    defaults:
      run:
        shell: bash
        working-directory: infra

    steps:

      - name: Checkout
        uses: actions/checkout@v4

# Option: paramètre pour choisir la branche à détruire (par défaut main)
# on.workflow_dispatch.inputs.branch -> default: "main"

      - name: Download tfstate from last successful apply run
        uses: dawidd6/action-download-artifact@v6
        with:
          repo: ${{ github.repository }}
          workflow: terraform-aws.yml        # ← nom du fichier du workflow d'apply
          workflow_conclusion: success
          branch: ${{ inputs.branch || 'main' }}
          name: tfstate-${{ inputs.branch || 'main' }}  # doit matcher le nom côté upload
          path: infra/

      - name: Verify tfstate presence
        run: |
          echo "Content of infra/:"
          ls -la infra || true
          test -f infra/terraform.tfstate && echo "OK: tfstate trouvé" || (echo "::warning::Pas de tfstate local (backend distant ? mauvais nom d'artifact ?)"; exit 0)


      - name: Assert 'infra/' exists & show tree
        working-directory: .
        run: |
          echo "PWD: $(pwd)"
          ls -la .
          ls -la infra || (echo "::error::Le dossier 'infra' est introuvable." && exit 1)

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.13.2"

      - name: Restore Terraform plugin cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infra/.terraform
          key: tf-${{ runner.os }}-${{ hashFiles('infra/**/*.tf', 'infra/.terraform.lock.hcl') }}
          restore-keys: |
            tf-${{ runner.os }}-

      - name: Terraform init
        env:
          TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
        run: terraform init -input=false

      - name: Terraform plan -destroy (dry-run)
        env:
          TF_CLI_ARGS_plan: "-no-color"
        run: |
          set -euo pipefail
          ARGS=()
          if [ -n "${{ github.event.inputs.var_file }}" ]; then
            ARGS+=("-var-file=${{ github.event.inputs.var_file }}")
          fi
          if [ -n "${{ github.event.inputs.target }}" ]; then
            ARGS+=("-target=${{ github.event.inputs.target }}")
          fi
          terraform plan -destroy -out=tfplan.destroy "${ARGS[@]}"
          terraform show -no-color tfplan.destroy > tfplan-destroy.txt

      - name: Upload destroy plan (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-destroy
          path: infra/tfplan-destroy.txt

      - name: Terraform destroy (apply)
        env:
          TF_CLI_ARGS_destroy: "-no-color"
        run: |
          set -euo pipefail
          ARGS=()
          if [ -n "${{ github.event.inputs.var_file }}" ]; then
            ARGS+=("-var-file=${{ github.event.inputs.var_file }}")
          fi
          if [ -n "${{ github.event.inputs.target }}" ]; then
            ARGS+=("-target=${{ github.event.inputs.target }}")
          fi
          terraform destroy -auto-approve "${ARGS[@]}"

      # 2️⃣ Ré-upload du tfstate (vide ou mis à jour après destruction)
      - name: Upload updated tfstate
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfstate
          path: |
            infra/terraform.tfstate
            infra/terraform.tfstate.backup
          if-no-files-found: ignore
